# 消息存储

## 每条消息会存储到每个用户的消息队列，包括发送者和接受者
所有消息都会保存，每个用户的个人消息（包括他所发送和接受的）只会存储在一台机器上，
这样能够能够方便的获取到个人的聊天历史记录，同时也导致一条消息会存储两份，
发送者和接受者各自一份。
消息存储文件以appendonly的模式打开， 每条新消息会被append到文件尾部。


## 消息接受
每个用户终端保存上次接受到的消息的synckey， 当有新消息通知或者首次上线时，用synckey去同步服务器的新消息，在收到新消息后， 保存新的synckey， 并继续等待新消息通知。
以同步的方式获取所有的消息（包括在线，离线），这样能够保证消息的有序和不会丢失，也能够保证多端消息的一致性。
服务器同时在redis中记录下每个用户最后的synckey， 这样当用户卸载后重新安装app使用服务器保存的synckey来同步新消息。


# 服务器扩容
1. im实例随时可以添加，不需要停机。
2. imr实例添加的时候，需要改变所有im实例的配置，然后重启所有的im实例。
3. 添加ims实例:
     一台服务器上可以部署多个ims实例。
     ims实例数目只能倍增， 不能单独添加一个实例。
     在添加相同数目的ims实例时，还需要将旧实例的数据按序copy到新实例。
     更改所有im实例的配置，然后重启所有im实例。
